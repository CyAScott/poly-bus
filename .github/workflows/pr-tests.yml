name: PR Tests with Coverage

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - '.github/workflows/pr-tests.yml'

jobs:
  dotnet-tests:
    name: .NET Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/dotnet
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build
        run: dotnet build --no-restore --configuration Release
      
      - name: Run tests with coverage
        run: dotnet test --no-build --configuration Release --collect:"XPlat Code Coverage" --results-directory ./coverage
      
      - name: Upload .NET coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./src/dotnet/coverage/**/coverage.cobertura.xml
          flags: dotnet
          name: dotnet-coverage

  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/python
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests with coverage
        run: pytest --cov=src --cov-report=xml --cov-report=term-missing
      
      - name: Upload Python coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./src/python/coverage.xml
          flags: python
          name: python-coverage

  typescript-tests:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/typescript
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/typescript/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with coverage
        run: npm run test:ci
      
      - name: Upload TypeScript coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./src/typescript/coverage/coverage-final.json
          flags: typescript
          name: typescript-coverage

  coverage-summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [dotnet-tests, python-tests, typescript-tests]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "All project tests have completed. Check individual job results for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ .NET Tests: ${{ needs.dotnet-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Python Tests: ${{ needs.python-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TypeScript Tests: ${{ needs.typescript-tests.result }}" >> $GITHUB_STEP_SUMMARY
